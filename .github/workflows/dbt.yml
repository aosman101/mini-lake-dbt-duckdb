name: dbt build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install dbt-core dbt-duckdb
          # ensure duckdb Python package is available for the creation step
          python -m pip install duckdb

      - name: Verify duckdb availability
        run: |
          python - <<'PY'
          import duckdb, sys
          try:
              print('duckdb import OK, version=', duckdb.__version__)
          except Exception as e:
              print('duckdb import failed:', e)
              sys.exit(1)
          PY

      - name: Create CI DuckDB file (verbose)
        run: |
          set -eux
          echo "PWD: $(pwd)"
          echo "Listing repo root:"
          ls -la
          mkdir -p mini_lake/data
          echo "Creating mini_lake/data/ci.duckdb via python"
          python - <<'PY'
          import duckdb, os
          os.makedirs('mini_lake/data', exist_ok=True)
          con = duckdb.connect('mini_lake/data/ci.duckdb')
          con.execute("CREATE TABLE IF NOT EXISTS _init(x INT);")
          con.execute("INSERT INTO _init VALUES (1);")
          con.close()
          print('Created mini_lake/data/ci.duckdb')
          PY
          echo "Listing mini_lake and data directory after create:"
          ls -la mini_lake || true
          ls -la mini_lake/data || true

      - name: Provide dbt profile (DuckDB) with absolute path
        run: |
          mkdir -p .ci
          DB_PATH="$GITHUB_WORKSPACE/mini_lake/data/ci.duckdb"
          echo "Using DB path: $DB_PATH"
          printf '%s\n' "mini_lake:" "  target: dev" "  outputs:" "    dev:" "      type: duckdb" "      path: \"$DB_PATH\"" "      threads: 4" > .ci/profiles.yml
          echo "Wrote .ci/profiles.yml:" && sed -n '1,240p' .ci/profiles.yml
        shell: bash

      - name: dbt build
        run: |
          cd mini_lake
          dbt deps || true   # not needed now, but harmless
          dbt build --profiles-dir ../.ci
